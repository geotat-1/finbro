<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–£—á—ë—Ç —Å—á–µ—Ç–æ–≤ ‚Äî GitHub Pages</title>
  <style>
    body { font-family: Inter, Arial, sans-serif; padding:24px; background:#f7fafc; color:#111 }
    h1 { margin-top:0 }
    table { width:100%; border-collapse:collapse; margin-top:12px }
    th,td { border:1px solid #e6e9ee; padding:8px; text-align:left }
    th { background:#f1f5f9 }
    .card { background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.04); margin-top:12px }
    label{display:block;margin-top:8px}
    input,select,button{padding:8px;margin-top:6px;width:100%;box-sizing:border-box}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
  </style>
</head>
<body>
  <h1>üí∞ –£—á—ë—Ç —Å—á–µ—Ç–æ–≤</h1>

  <div class="card">
    <div id="totalBalance">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <table id="accountsTable">
      <thead><tr><th>–°—á—ë—Ç</th><th>–ë–∞–ª–∞–Ω—Å</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h2>
    <form id="txForm">
      <label>–¢–∏–ø
        <select id="type">
          <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>
          <option value="income">–î–æ—Ö–æ–¥</option>
          <option value="expense">–†–∞—Å—Ö–æ–¥</option>
        </select>
      </label>

      <div class="row">
        <label>–û—Ç–∫—É–¥–∞
          <select id="from"><option value="">‚Äî</option></select>
        </label>
        <label>–ö—É–¥–∞
          <select id="to"><option value="">‚Äî</option></select>
        </label>
      </div>

      <label>–¢–µ–≥–∏
        <input id="tags" placeholder="–Ω–∞–ø—Ä. –µ–¥–∞, –∑–∞—Ä–ø–ª–∞—Ç–∞" />
      </label>

      <label>–°—É–º–º–∞
        <input id="amount" type="number" step="0.01" required />
      </label>

      <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
    <div id="txStatus" style="margin-top:8px"></div>
  </div>

  <script>
    // –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ URL –≤–∞—à–µ–≥–æ Apps Script Web App:
    const GAS_WEBAPP_URL = 'GAS_WEBAPP_URL_REPLACE_ME';

    async function apiGet(action, params = {}) {
      const url = new URL(GAS_WEBAPP_URL);
      url.searchParams.set('action', action);
      for (const k in params) url.searchParams.set(k, params[k]);
      const res = await fetch(url.toString(), { method: 'GET' });
      return res.json();
    }

    async function apiPost(action, body = {}) {
      const payload = { action, ...body };
      const res = await fetch(GAS_WEBAPP_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      return res.json();
    }

    async function loadAccounts() {
      document.getElementById('totalBalance').innerText = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      const data = await apiGet('getAccounts');
      if (!data) { document.getElementById('totalBalance').innerText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'; return; }

      // –µ—Å–ª–∏ –æ–±—ë—Ä—Ç–∫–∞ {ok:true, ...}
      const accounts = data.ok === false && data.error ? [] : (data.ok && data.length===undefined ? data : data);
      // above: if your GAS returns {ok:true, ...}, adjust accordingly. We'll try best-effort.
      let arr = accounts;
      // Sometimes GAS returned {ok:true, result: [...]}
      if (data.result && Array.isArray(data.result)) arr = data.result;
      if (!Array.isArray(arr) && Array.isArray(data)) arr = data;

      const tbody = document.querySelector('#accountsTable tbody');
      tbody.innerHTML = '';
      let total = 0;
      arr.forEach(acc => {
        const name = acc.name || acc['name'] || '';
        const balance = parseFloat(acc.balance || acc['balance'] || 0) || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(name)}</td><td>${balance.toFixed(2)}</td>`;
        tbody.appendChild(tr);
        total += balance;
      });

      document.getElementById('totalBalance').innerText = `–û–±—â–∏–π –±–∞–ª–∞–Ω—Å: ${total.toFixed(2)}`;

      // –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç—ã
      const from = document.getElementById('from'), to = document.getElementById('to');
      [from, to].forEach(s => { s.innerHTML = '<option value="">‚Äî</option>'; });
      arr.forEach(acc => {
        const name = acc.name || acc['name'] || '';
        [from, to].forEach(s => {
          const o = document.createElement('option'); o.value = name; o.textContent = name; s.appendChild(o);
        });
      });
    }

    document.getElementById('txForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const tx = {
        type: document.getElementById('type').value,
        from: document.getElementById('from').value,
        to: document.getElementById('to').value,
        tags: document.getElementById('tags').value,
        amount: parseFloat(document.getElementById('amount').value)
      };
      document.getElementById('txStatus').innerText = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
      try {
        const resp = await apiPost('addTransaction', { transaction: tx });
        if (resp && resp.ok === false) {
          document.getElementById('txStatus').innerText = '–û—à–∏–±–∫–∞: ' + (resp.error || JSON.stringify(resp));
        } else {
          document.getElementById('txStatus').innerText = 'OK ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞';
          document.getElementById('txForm').reset();
          await loadAccounts();
        }
      } catch (err) {
        document.getElementById('txStatus').innerText = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err;
      }
    });

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }

    // init
    loadAccounts();
  </script>
</body>
</html>
